os: linux
dist: bionic
language: python
python:
  - "3.6"
  - "3.7"
  - "3.8"
services:
  - postgresql

env:
  DOCKER_COMPOSE_VERSION: 1.25.4
  HEROKU_REGISTRY_IMAGE: registry.heroku.com/$HEROKU_APP_NAME/web
  DATABASE_TEST_USER: postgres
  DATABASE_TEST_PASSWORD: postgres
  DATABASE_TEST_NAME: users
  DATABASE_TEST_HOST: db
  DATABASE_TEST_PORT: 5432
  DATABASE_TEST_DOCKER_URL: postgresql://$DATABASE_TEST_USER:$DATABASE_TEST_PASSWORD@$DATABASE_TEST_HOST:$DATABASE_TEST_PORT/$DATABASE_TEST_NAME
  FLASK_APP: project/__init__.py
  FLASK_ENV: development
  APP_SETTINGS: project.config.DevelopmentConfig

before_install:
  - python --version

install:
  # try to move under a directory
  - if [[ $TRAVIS_BRANCH == "develop" ]] && [[ $TRAVIS_PYTHON_VERSION == "3.8" ]]; then
      chmod +x ./.travis_build.sh;
      ./.travis_build.sh;
    fi
  - pip install -r requirements.txt

before_script:
  # Swap to only one DATABASE_TEST_URL
  - export DATABASE_TEST_URL=postgresql://$DATABASE_TEST_USER@127.0.0.1:$DATABASE_TEST_PORT/$DATABASE_TEST_NAME
  - psql -c "CREATE DATABASE users;" -U postgres
  - gunicorn -b 0.0.0.0:5000 manage:app --daemon

script:
  - python -m pytest "project/tests" --cov="project"
  - python -m black project
  - python -m flake8 project
  - python -m isort project/**/*.py --check-only

after_success:
  # python --version
  # - if [[ $TRAVIS_BRANCH == "master" ]] && [[ $TRAVIS_PULL_REQUEST == "false" ]]; then
  - if [[ $TRAVIS_PYTHON_VERSION == "3.8" ]]; then
      python -m coveralls;
      python -m codecov;
    fi
  - pkill gunicorn

#jobs:
#  include:
#    - stage: code-coverage
#      python: "3.8"
#      script: |
#        python -m coveralls;
#        python -m codecov;